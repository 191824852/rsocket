## Introduction

Key words used by this document conform to the meanings in [RFC 2119](https://tools.ietf.org/html/rfc2119).

## Terminology

* __Frame__: A frame of data containing a request or a response.
* __Transport__: Protocol used to carry ReactiveSockets protocol. Such as WebSockets, TCP, Aeron, etc.
* __Stream__: Unit of operation (request/response, etc.). See [Design Principles](DesignPrinciples.md).
* __Request__: A stream request. May be one of four types.
* __Response__: A stream response. Comprised of 1 or more headers chained together that contain data, control, and metadata.
* __Client__: The side connecting to a server.
* __Server__: The side accepting connections from clients.
* __Connection__: The instance of a transport session between client and server.
* __Requester__: The side sending a request. A connection has at most 2 Requesters. One in each direction.
* __Responder__: The side receiving a request. A connection has at most 2 Responders. One in each direction.

## Operation

### Frame Header Format

ReactiveSocket frames begin with a header. The general layout is given below. When used over
transport protocols that provide framing (WebSocket and Aeron), the Frame Length field is not included.
For transports that do not provide framing, such as TCP, the Frame Length MUST be included.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |I|   Flags     |         Frame Type            |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                           Depends on Frame Type
```

* __Frame Length__: (31 = max 2,147,483,647 bytes) Length of Frame. Including header. Only used for TCP.
* __Version__: (8) Current version is 0.
* __Flags__:
     * __I__gnore: Ignore frame if not understood
* __Frame Type__: (16) Type of Frame.
* __Stream ID__: (64) Stream Identifier for this frame.

### Stream Identifiers

#### Generation

Stream IDs are generated by a Requester. The lifetime of a Stream ID is determined by the request type and
the semantics of the stream based on its type.

Stream ID value of 0 is reserved for any operation involving the connection.

A stream ID must be locally unique for a Requester in a connection.

### Frame Types

|  Type                          | Value  | Description |
|:-------------------------------|:-------|:------------|
| __RESERVED__                   | 0x0000 | __Reserved__ |
| __SETUP__                      | 0x0001 | __Setup__: Capabilities Of Side Sending The Frame. |
| __REQUEST_RESPONSE__           | 0x0011 | __Request Response__: |
| __REQUEST_FNF__                | 0x0012 | __Fire And Forget__: |
| __REQUEST_STREAM__             | 0x0013 | __Request Stream__: |
| __REQUEST_SUB__                | 0x0014 | __Request Subscription__: |
| __REQUEST_N__                  | 0x0015 | __Request N__: Request N more items |
| __CANCEL__                     | 0x0016 | __Cancel Request__: |
| __RESPONSE__                   | 0x0020 | __Response__: Response to a request. |
| __EXT__                        | 0xFFFF | __Extension Header__: Used To Extend More Options As Well As Extensions. |

### Header Chains

ReactiveSocket uses IPv6-style header chains to provide flexibility. The general layout of a ReactiveSocket
frame is a Frame Header followed by 0 or more Headers.

__Note__: Currently, only RESPONSEs use header chains.

```
     +----------------------------------------+
     |       Frame Length (for TCP only)      |
     +----------------------------------------+
     | Frame Header (version, Stream ID, etc.)|
     +----------------------------------------+
     |                 Header                 |
     +----------------------------------------+
     |                 Header                 |
     +----------------------------------------+
     |                 ......                 |
     +----------------------------------------+
     |                 Header                 |
     +----------------------------------------+
```

The general format for a header is given below.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +---------------+-+---------------------------------------------+
                        Header Data (Depends on Type)
```

* __Type__: (8) Type of header.
* __Flags__:
    * (__I__)gnore: ignore current header if not understood.
* __Header Length__: (23) Length of current header in bytes (23 = max 8,388,608 bytes). Includes
the Type and Header Length fields.

#### Header Types

|  Type                              | Value  | Description |
|:-----------------------------------|:-------|:------------|
| __HDR_RESERVED__                   | 0x00 | __Reserved__ |
| __HDR_NEXT__                       | 0x22 | __Next__: |
| __HDR_COMPLETE__                   | 0x23 | __Complete__: |
| __HDR_ERROR__                      | 0x24 | __Error__: |
| __HDR_EXT__                        | 0xFF | __Extension Header__: Used To Extend More Options As Well As Extensions. |

__Note__: Headers Sent By Requesters Fall Into The 0x10 - 0x1F Range. Headers Sent By Responders Fall Into The 0x20 - 0x2F Range.

### Setup Frame

Setup headers must always use Stream ID 0 as they pertain to the connection.

Frame Contents

1. __Setup Data__: includes payload describing connection capabilities of the endpoint sending the
Setup header.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |0|   Flags     |     Frame Type = SETUP        |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                               Setup Data
```

### Request Response Frame

Frame Contents

1. __Request Data__: identification of the service being requested along with parameters for the request.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |0|   Flags     | Frame Type = REQUEST_RESPONSE |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                              Request Data
```

### Request Fire-n-Forget Frame

Frame Contents

1. __Request Data__: identification of the service being requested along with parameters for the request.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |0|   Flags     |    Frame Type = REQUEST_FNF   |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                               Request Data
```

### Request Stream Frame

Frame Contents

1. __Initial Request N__: initial Request N value. 64-bit integer.
1. __Request Data__: identification of the service being requested along with parameters for the request.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |I|   Flags     |  Frame Type = REQUEST_STREAM  |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                        Initial Request N                      |
    |                                                               |
    +---------------------------------------------------------------+
                                Request Data
```

### Request Subscription Frame

Frame Contents

1. __Initial Request N__: initial Request N value. 64-bit integer.
1. __Request Data__: identification of the service being requested along with parameters for the request.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |I|   Flags     |    Frame Type = REQUEST_SUB   |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                       Initial Request N                       |
    |                                                               |
    +---------------------------------------------------------------+
                               Request Data
```

### Request N Frame

Frame Contents

1. __Request N__: 64-bit integer value of items to request.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |I|   Flags     |     Frame Type = SETUP        |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                           Request N                           |
    |                                                               |
    +---------------------------------------------------------------+
```

### Cancel Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |I|   Flags     |     Frame Type = CANCEL       |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
```

### Response Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |I|   Flags     |    Frame Type = RESPONSE      |
    +---------------+-+-------------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                            Header                             |
    +---------------------------------------------------------------+
    |                            Header                             |
    +---------------------------------------------------------------+
    |                              ...                              |
    +---------------------------------------------------------------+
    |                            Header                             |
    +---------------------------------------------------------------+
```

RESPONSE frames have a chain of headers that contains payload.

#### Next Header

Contents

1. 1 Byte Fragment Information:
    1. __Begin Bit__: bit to indicate beginning of a fragmented element.
    1. __End Bit__: bit to indicate end of a fragmented element.
1. __Header Data__: payload for onNext.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +-+-+-----------+-+---------------------------------------------+
    |B|E|  Reserved |          Header Data (Depends on Type)       ...
    +-+-+-----------+
```

#### Error Header

Contents

1. __Header Data__: error information.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +-+-+-----------+-+---------------------------------------------+
                              Header Data
```

#### Complete Header

Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +-+-+-----------+-+---------------------------------------------+
```

#### Extension Header

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     0xFF      |I|                Extended Type                |
    +---------------+-+---------------------------------------------+
    |                         Header Length                         |
    +---------------------------------------------------------------+
                          Depends on Extended Type...
```

* __Frame Type__: (8) 0xFF for Extension Header.
* __Flags__:
    * (__I__)gnore: Can be ignored.
* __Extended Type__: Extended type information

### Extension Frame

The general format for an extension frame is given below.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-------------+-------------------------------+
    |    Version    |I|   Flags     |     Frame Type = EXT          |
    +---------------+-+-------------+-------------------------------+
    |                        Extended Type                          |
    +---------------------------------------------------------------+
                          Depends on Extended Type...
```

* __Frame Type__: (16) 0xFFFF for Extension Header.
* __Flags__:
    * (__I__)gnore: Can be ignored.
* __Extended Type__: Extended type information

## Connection Establishment

__NOTE__: The semantics are similar to [TLS False Start](https://tools.ietf.org/html/draft-bmoeller-tls-falsestart-00).

Immediately upon successful connection, the client MUST send a SETUP frame with
Stream ID of 0. The client-side Requester may send requests immediately if it so desires without waiting for
a response from the server.

If the server accepts the contents of the SETUP frame, it does nothing special. The server-side Requester may send requests immediately
upon receiving a SETUP frame that it accepts.

If the server does NOT accept the contents of the SETUP frame, the server MUST send back an ERROR on Stream ID 0
and then close the connection.

A client assumes a SETUP is accepted if it receives a response to a request or if it sees a REQUEST type.

A client assumes a SETUP is rejected if it receives an ERROR with stream ID 0. 

### Negotiation

The assumption is that the client will be dictating to the server what it desires to do. The server will decide to support
that SETUP (accept it) or not (reject it).

### Sequences

1. Client-side Request, Server-side __accepts__ SETUP
    * Client connects & sends SETUP & sends REQUEST
    * Server accepts SETUP, handles REQUEST, sends back normal sequence based on REQUEST type
1. Client-side Request, Server-side __rejects__ SETUP
    * Client connects & sends SETUP & sends REQUEST
    * Server rejects SETUP, sends back ERROR stream ID 0, closes connection
1. Server-side Request, Server-side __accepts__ SETUP
    * Client connects & sends SETUP
    * Server accepts SETUP, sends back REQUEST type
1. Server-side Request, Server-side __rejects__ SETUP
    * Client connects & sends SETUP
    * Server rejects SETUP, sends back ERROR stream ID 0, closes connection

## Fragmentation And Reassembly

RESPONSE frames with NEXT headers may respresent a large object and MAY need to be fragmented to fit within the Header Data size. When this
occurs, the NEXT headers Begin and End bits must be used to indicate a begin fragment and an end fragment. Or, when
both bits set, the contents represent a complete NEXT header.

## Stream Sequences and Lifetimes

In the section below, "RQ -> RS" refers to Requester sending a frame to a Responder. And "RS -> RQ" refers to Responder sending
a frame to a Requester.

In the section below, "*" refers to 0 or more and "+" refers to 1 or more.

### Request Response

1. RQ -> RS: REQUEST_RESPONSE
1. RS -> RQ: RESPONSE with NEXT and COMPLETE

or

1. RQ -> RS: REQUEST_RESPONSE
1. RS -> RQ: RESPONSE with ERROR

or

1. RQ -> RS: REQUEST_RESPONSE
1. RQ -> RS: RESPONSE with CANCEL

Upon sending a response, the stream is terminated on the Responder.

Upon receiving a CANCEL, the stream is terminated on the Responder and the response should not be sent.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

### Request Fire-n-Forget

1. RQ -> RS: REQUEST_FNF

Upon reception, the stream is terminated by the Responder.

Upon being sent, the stream is terminated by the Requester.

REQUEST_FNF are assumed to be best effort and MAY not be processed due to: (1) SETUP rejection, (2) mis-formatting, (3) etc.

### Request Stream

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE with 0 or more NEXTs
1. RS -> RQ: RESPONSE with ERROR

or

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE with 1 or more NEXTs
1. RS -> RQ: RESPONSE with COMPLETE

or 

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE with 0 or more NEXTs
1. RQ -> RS: CANCEL

At any time, a client may send REQUEST_N frames.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

Upon sending a COMPLETE or ERROR, the stream is terminated on the Responder.

### Request Subscription

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE with 0 or more NEXTs

or

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE with 0 or more NEXTs
1. RS -> RQ: RESPONSE with ERROR

or

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE with 0 or more NEXTs
1. RQ -> RS: CANCEL

At any time, a client may send REQUEST_N frames.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a ERROR, the stream is terminated on the Requester.

Upon sending a ERROR, the stream is terminated on the Responder.

### Per Stream State

#### Requester

1. CLOSED: implicit starting/ending state of all stream IDs
1. Requested (sent REQUEST_*)
1. CLOSED (received COMPLETE or sent REQUEST_FNF)
1. CLOSED (received ERROR)

#### Responder

1. CLOSED: implicit starting/ending state of all stream IDs
1. Responding: sending NEXTs and processing REQUEST_N
1. CLOSED (received CANCEL)
1. CLOSED (sent COMPLETE or received REQUEST_FNF)
1. CLOSED (sent ERROR)

#### Handling the Unexpected

* Recieving a header in a state that is not specified means it is ignored (or causes termination?)
* Should StreamIDs be timedout after inactivity?
    * if so, need keepalive semantics

### TODO

1. REQUEST_N needs to return point in stream in some way. Or even a new header type REQUEST_N_POSITIONED, or POSITION header, e.g.
    * object (NEXT) counter
1. Connection instance
    * Requester instance
    * Responder instance
1. Exlicit METADATA header needed?
    * need metadata semantics
1. Explore
    * RESPONSE Frame
        * remove header type and bring BE flags byte into header type location. Keep length.
    * remove COMPLETE and add C bit to NEXT (COMPLETE is a NEXT header with C bit set and no data)
    * remove ERROR and add R bit to NEXT (ERROR is a NEXT header with R bit set and optionally data)
    * keep extension header and add 0xF after BECR flags to extend to new types.
