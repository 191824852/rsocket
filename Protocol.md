## Introduction

Key words used by this document conform to the meanings in [RFC 2119](https://tools.ietf.org/html/rfc2119).

## Terminology

* __Frame__: A frame of data containing a request or a response.
* __Transport__: Protocol used to carry ReactiveSockets protocol. Such as WebSockets, TCP, Aeron, etc.
* __Stream__: Unit of operation (request/response, etc.). See [Design Principles](DesignPrinciples.md).
* __Request__: A stream request. May be one of four types. As well as request for more items or cancellation of previous request.
* __Response__: A stream response. Contains data associated with previous request.
* __Client__: The side connecting to a server. i.e. initiating a connection.
* __Server__: The side accepting connections from clients.
* __Connection__: The instance of a transport session between client and server.
* __Requester__: The side sending a request. A connection has at most 2 Requesters. One in each direction.
* __Responder__: The side receiving a request. A connection has at most 2 Responders. One in each direction.

## Operation

### Frame Header Format

ReactiveSocket frames begin with a header. The general layout is given below. When used over
transport protocols that provide framing (WebSocket and Aeron), the Frame Length field is not included.
For transports that do not provide framing, such as TCP, the Frame Length MUST be included.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |I|M|  Flags    |         Frame Type            |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                           Depends on Frame Type
```

* __Frame Length__: (31 = max 2,147,483,647 bytes) Length of Frame. Including header. Only used for TCP.
* __Version__: (8) Current version is 0.
* __Flags__:
     * (__I__)gnore: Ignore frame if not understood
     * (__M__)etadata: Metdadata present (or not)
* __Frame Type__: (16) Type of Frame.
* __Stream ID__: (64) Stream Identifier for this frame.

#### Metadata Optional Header

Specific Frame Types MAY contain an optional metadata header that provides metadata about a frame.
This metadata header is between the Frame Header and any payload.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |       Type    |           Metadata Length                     |
    +---------------+-----------------------------------------------+
    |                       Metadata Payload                       ...
    +---------------------------------------------------------------+
    |                       Payload of Frame                       ...
    +---------------------------------------------------------------+
```

* __Type__: Application-defined Type field for the metadata. Not interpretted by protocol.
* __Metadata Length__: (24 = max 16,777,216 bytes) Length of Metadata. Including Metadata header.

### Stream Identifiers

#### Generation

Stream IDs are generated by a Requester. The lifetime of a Stream ID is determined by the request type and
the semantics of the stream based on its type.

Stream ID value of 0 is reserved for any operation involving the connection.

A stream ID must be locally unique for a Requester in a connection.

### Frame Types

|  Type                          | Value  | Description |
|:-------------------------------|:-------|:------------|
| __RESERVED__                   | 0x0000 | __Reserved__ |
| __SETUP__                      | 0x0001 | __Setup__: Capabilities Of Side Sending The Frame. |
| __SETUP_ERROR__                | 0x0002 | __Setup Error__: Error from SETUP. |
| __LEASE__                      | 0x0003 | __Lease__: |
| __REQUEST_RESPONSE__           | 0x0011 | __Request Response__: |
| __REQUEST_FNF__                | 0x0012 | __Fire And Forget__: |
| __REQUEST_STREAM__             | 0x0013 | __Request Stream__: |
| __REQUEST_SUB__                | 0x0014 | __Request Subscription__: |
| __REQUEST_N__                  | 0x0015 | __Request N__: Request N more items |
| __CANCEL__                     | 0x0016 | __Cancel Request__: |
| __RESPONSE__                   | 0x0020 | __Response__: Response to a request. |
| __ERROR__                      | 0x0021 | __Error__: Response that is an error. |
| __EXT__                        | 0xFFFF | __Extension Header__: Used To Extend More Options As Well As Extensions. |

__NOTE__: In general Requesters send types 0x0010 to 0x001F and Responders send types 0x0020 to 0x002F.

### Setup Frame

Setup frames must always use Stream ID 0 as they pertain to the connection.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-+---------+-------------------------------+
    |    Version    |0|M|L| Flags   |     Frame Type = SETUP        |
    +---------------+-+-+-+---------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                           Metadata & Setup Data
```

* __Flags__:
     * (__L__): Will honor LEASE (or not).
* __Setup Data__: includes payload describing connection capabilities of the endpoint sending the
Setup header.

### Setup Error Frame

Setup Error frames must always use Stream ID 0 as they pertain to the connection.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |     Frame Type = SETUP ERROR  |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                          Error Code                           |
    +---------------------------------------------------------------+
                        Metadata & Setup Error Data
```

* __Error Code__: Type of Error.
* __Setup Error Data__: includes payload describing connection capabilities of the endpoint sending the
Setup header.

#### Error Codes

|  Type                          | Value  | Description |
|:-------------------------------|:-------|:------------|
| __RESERVED__                   | 0x0000 | __Reserved__ |
| __RESERVED__                   | 0xFFFF | __Reserved__ |

### Lease Frame

Lease frames must always use Stream ID 0 as they pertain to the Connection.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|0|  Flags    |     Frame Type = LEASE        |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                             Time                              |
    |                                                               |
    +---------------------------------------------------------------+
    |                       Number of Requests                      |
    |                                                               |
    +---------------------------------------------------------------+
```

* __Time__: Time (in nanoseconds) for validity of LEASE
* __Number of Requests__: Number of Requests that may be sent until next LEASE

### Request Response Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    | Frame Type = REQUEST_RESPONSE |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                         Metadata & Request Data
```

* __Request Data__: identification of the service being requested along with parameters for the request.

### Request Fire-n-Forget Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |    Frame Type = REQUEST_FNF   |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                          Metadata & Request Data
```

* __Request Data__: identification of the service being requested along with parameters for the request.

### Request Stream Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |  Frame Type = REQUEST_STREAM  |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                        Initial Request N                      |
    |                                                               |
    +---------------------------------------------------------------+
                          Metadata & Request Data
```

* __Initial Request N__: initial Request N value. 64-bit integer.
* __Request Data__: identification of the service being requested along with parameters for the request.

### Request Subscription Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|M|  Flags    |    Frame Type = REQUEST_SUB   |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                       Initial Request N                       |
    |                                                               |
    +---------------------------------------------------------------+
                           Metadata & Request Data
```

* __Initial Request N__: initial Request N value. 64-bit integer.
* __Request Data__: identification of the service being requested along with parameters for the request.

### Request N Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |0|0|   Flags   |     Frame Type = SETUP        |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
    |                           Request N                           |
    |                                                               |
    +---------------------------------------------------------------+
```

* __Request N__: 64-bit integer value of items to request.

### Cancel Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |I|0|  Flags    |     Frame Type = CANCEL       |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
```

### Response Frame

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-+-+-+-----+-------------------------------+
    |    Version    |I|M|B|E|C|     |    Frame Type = RESPONSE      |
    +---------------+-+-+-+-+-+-----+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                         Metadata & Response Data
```

* __Flags__:
    * (__B__)egin: bit to indicate beginning of a fragmented response.
    * (__E__)nd: bit to indicate end of a fragmented response.
    * (__C__)omplete: bit to indicate COMPLETE.
* __Response Data__: payload for onNext.

A Response is generally referred to as a NEXT.

A Response with the Complete Bit set is referred to as a COMPLETE.

#### Error Frame

An ERROR frame is used as a means of communicating a stream ERROR from a Responder to a Requester.

Frame Contents

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |I|0| Reserved  |      Frame Type = ERROR       |
    +---------------+-+-+-----------+-------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                              Error Data
```

* __Error Data__: error information.

### Extension Frame

The general format for an extension frame is given below.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-+-+-----------+-------------------------------+
    |    Version    |I|M|  Flags    |     Frame Type = EXT          |
    +---------------+-+-+-----------+-------------------------------+
    |                        Extended Type                          |
    +---------------------------------------------------------------+
                          Depends on Extended Type...
```

* __Frame Type__: (16) 0xFFFF for Extension Header.
* __Flags__:
    * (__I__)gnore: Can be ignored.
    * (__M__)etadata: Metadata present.
* __Extended Type__: Extended type information

## Connection Establishment

__NOTE__: The semantics are similar to [TLS False Start](https://tools.ietf.org/html/draft-bmoeller-tls-falsestart-00).

Immediately upon successful connection, the client MUST send a SETUP frame with
Stream ID of 0. 

A client-side Requester can inform the server-side Responder as to whether it will honor LEASEs or not based on the presence of
the __L__ flag in the Frame Header.

The client-side Requester that has NOT set the __L__ flag in the SETUP frame may send requests immediately if it so desires without waiting for
a response from the server.

The client-side Requester that has set the __L__ flag in the SETUP frame MUST wait for the server-side Responder to send a LEASE frame
before it can send Requests.

If the server accepts the contents of the SETUP frame, it MUST send a LEASE frame if the SETUP frame set the __L__ flag.
The server-side Requester may send requests immediately upon receiving a SETUP frame that it accepts.

If the server does NOT accept the contents of the SETUP frame, the server MUST send back a SETUP_ERROR
and then close the connection.

A client assumes a SETUP is accepted if it receives a response to a request, a LEASE frame, or if it sees a REQUEST type.

A client assumes a SETUP is rejected if it receives a SETUP_ERROR.

### Negotiation

The assumption is that the client will be dictating to the server what it desires to do. The server will decide to support
that SETUP (accept it) or not (reject it).

### Sequences with no LEASE

The possible sequences with no LEASE are below.

1. Client-side Request, Server-side __accepts__ SETUP
    * Client connects & sends SETUP & sends REQUEST
    * Server accepts SETUP, handles REQUEST, sends back normal sequence based on REQUEST type
1. Client-side Request, Server-side __rejects__ SETUP
    * Client connects & sends SETUP & sends REQUEST
    * Server rejects SETUP, sends back ERROR stream ID 0, closes connection
1. Server-side Request, Server-side __accepts__ SETUP
    * Client connects & sends SETUP
    * Server accepts SETUP, sends back REQUEST type
1. Server-side Request, Server-side __rejects__ SETUP
    * Client connects & sends SETUP
    * Server rejects SETUP, sends back ERROR stream ID 0, closes connection

## Fragmentation And Reassembly

RESPONSE frames may respresent a large object and MAY need to be fragmented to fit within the Frame Data size. When this
occurs, the RESPONSE Begin and End bits must be used to indicate a begin fragment and an end fragment. Or, when
both bits set, the contents represent a reassembled RESPONSE.

## Stream Sequences and Lifetimes

In the section below, "RQ -> RS" refers to Requester sending a frame to a Responder. And "RS -> RQ" refers to Responder sending
a frame to a Requester.

In the section below, "*" refers to 0 or more and "+" refers to 1 or more.

### Request Response

1. RQ -> RS: REQUEST_RESPONSE
1. RS -> RQ: RESPONSE with COMPLETE

or

1. RQ -> RS: REQUEST_RESPONSE
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_RESPONSE
1. RQ -> RS: CANCEL

Upon sending a response, the stream is terminated on the Responder.

Upon receiving a CANCEL, the stream is terminated on the Responder and the response should not be sent.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

### Request Fire-n-Forget

1. RQ -> RS: REQUEST_FNF

Upon reception, the stream is terminated by the Responder.

Upon being sent, the stream is terminated by the Requester.

REQUEST_FNF are assumed to be best effort and MAY not be processed due to: (1) SETUP rejection, (2) mis-formatting, (3) etc.

### Request Stream

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE*
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE*
1. RS -> RQ: RESPONSE with COMPLETE

or 

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: RESPONSE*
1. RQ -> RS: CANCEL

At any time, a client may send REQUEST_N frames.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

Upon sending a COMPLETE or ERROR, the stream is terminated on the Responder.

### Request Subscription

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE*

or

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE*
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: RESPONSE*
1. RQ -> RS: CANCEL

At any time, a client may send REQUEST_N frames.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a ERROR, the stream is terminated on the Requester.

Upon sending a ERROR, the stream is terminated on the Responder.

### Per Stream State

#### Requester

1. CLOSED: implicit starting/ending state of all stream IDs
1. Requested (sent REQUEST_*)
1. CLOSED (received COMPLETE or sent REQUEST_FNF)
1. CLOSED (received ERROR)

#### Responder

1. CLOSED: implicit starting/ending state of all stream IDs
1. Responding: sending RESPONSEs and processing REQUEST_N
1. CLOSED (received CANCEL)
1. CLOSED (sent COMPLETE or received REQUEST_FNF)
1. CLOSED (sent ERROR)

#### Handling the Unexpected

* Recieving a header in a state that is not specified means it is ignored (or causes termination?)
* Should StreamIDs be timedout after inactivity?
    * if so, need keepalive semantics

### ChangeLog

1. Removed usage of header chains to discourage frames from being too large.

### TODO

- [ ] REQUEST_N needs to return point in stream in some way. Or even a new header type REQUEST_N_POSITIONED, or POSITION header, e.g.
    * object (NEXT) counter (and/or RESPONSE byte counter) kept as Requester stat for the stream
    * without the point in the stream, the window location is unclear and can lead to over-saturation of a subscriber
- [x] Need request throttling and back pressure semantics. A new Requester may need to be controlled as to how many requests it can send. Also,
it is probably necessary to throttle the amount of outstanding request a Requester can have outstanding. As well as make a Requester stop generating
new requests on command.
    * request throttling is a separation of concerns from flow control of a single stream/subscription
    - [ ] LEASE frame type for Responders to Requesters
- [ ] Stream ID should maybe be renamed to Request ID.
- [ ] naming
    - Connection instance
        * Requester instance
        * Responder instance
- [ ] Exlicit METADATA needed as mentioned in #3
    * need to understand metadata semantics
    * could be flag or explicit frame type or if needed to be attached to specific NEXT, could be option header
    * strawman
        * MD bit in Frame header
        * MD header contains length and application-set TYPE field (length = 24-bits (16,777,216 bytes), type = 8-bits)
- [x] eplicit SETUP_ERROR frame type with error code field + payload
- [x] add bit in SETUP for whether client expects response to SETUP
- [ ] Handling the unexpected questions
- [ ] Can replace BE bits with a single __M__ore bit that indicates more fragments follow the current fragment
