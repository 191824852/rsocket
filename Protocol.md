## Introduction

## Terminology

* __Frame__: A frame of data containing 1 or more headers chained together that contain data, control,
and metadata.
* __Transport__: Protocol used to carry ReactiveSockets protocol. Such as WebSockets, TCP, Aeron, etc.
* __Stream__: Unit of operation (request/response, etc.). See [Design Principles](DesignPrinciples.md).
* __Request__: A stream request. May be one of four types.
* __Client__: The side connecting to a server.
* __Server__: The side accepting connections from clients.
* __Requester__: The side sending a request.
* __Responder__: The side receiving a request.

## Operation

### Frame Header Format

ReactiveSocket frames begin with a header. The general layout is given below. When used over
transport protocols that provide framing (WebSocket and Aeron), the Frame Length field is not included.
For transports that do not provide framing, such as TCP, the Frame Length MUST be included.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |R|                 Frame Length (for TCP only)                 |
    +---------------+-----------------------------------------------+
    |    Version    |                  Reserved                     |
    +---------------+-----------------------------------------------+
    |                           Stream ID                           |
    |                                                               |
    +---------------------------------------------------------------+
                                  Headers
```

* __Frame Length__: (31 = max 2,147,483,647 bytes) Length of Frame. Including header. Only used for TCP.
* __Version__: (8) Current version is 0.
* __Stream ID__: (64) Stream Identifier for this frame.

### Stream Identifiers

#### Generation

Stream IDs are generated by a client. The lifetime of a Stream ID is determined by the request type and
the semantics of the stream based on its type.

Stream ID value of 0 is reserved for any operation involving the connection.

Stream ID generation SHOULD start at 1 and increase contiguously for each request type used by the client.

### Header Chains

ReactiveSocket uses IPv6-style header chains to provide flexibility. The general layout of a ReactiveSocket
frame is a Frame Header followed by 1 or more Headers.

```
     +----------------------------------------+
     |       Frame Length (for TCP only)      |
     +----------------------------------------+
     | Frame Header (version, Stream ID, etc.)|
     +----------------------------------------+
     |                 Header                 |
     +----------------------------------------+
     |                 Header                 |
     +----------------------------------------+
     |                 ......                 |
     +----------------------------------------+
     |                 Header                 |
     +----------------------------------------+
```

The general format for a header is given below.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +---------------+-+---------------------------------------------+
                        Header Data (Depends on Type)
```

* __Type__: (8) Type of header.
* __Flags__:
    * (__I__)gnore: ignore current header if not understood.
* __Header Length__: (23) Length of current header in bytes (23 = max 8,388,608 bytes). Includes
the Type and Header Length fields.

### Header Types

|  Type                              | Value  | Description |
|:-----------------------------------|:-------|:------------|
| __HDR_RESERVED__                   | 0x00 | __Reserved__ |
| __HDR_SETUP__                      | 0x01 | __Setup__: Capabilities of side sending the frame. |
| __HDR_REQUEST_RESPONSE__           | 0x11 | __Request Response__: |
| __HDR_REQUEST_FNF__                | 0x12 | __Fire and Forget__: |
| __HDR_REQUEST_STREAM__             | 0x13 | __Request Stream__: |
| __HDR_REQUEST_SUBSCRIPTION__       | 0x14 | __Request Subscription__: |
| __HDR_REQUEST_N__                  | 0x15 | __Request N__: Request N more items |
| __HDR_CANCEL__                     | 0x16 | __Cancel Request__: |
| __HDR_NEXT__                       | 0x22 | __Next__: |
| __HDR_COMPLETE__                   | 0x23 | __Complete__: |
| __HDR_ERROR__                      | 0x24 | __Error__: |
| __HDR_EXT__                        | 0xFF | __Extension Header__: Used to extend more options as well as extensions. |

__NOTE__: Headers sent by Requesters fall into the 0x10 - 0x1F range. Headers sent by Responders fall into the 0x20 - 0x2F range.

### Setup

Setup headers must always use Stream ID 0 as they pertain to the connection.

Contents

1. __Header Data__: includes payload describing connection capabilities of the endpoint sending the
Setup header.

### Request Response

Contents

1. __Header Data__: identification of the service being requested along with parameters for the request.

### Request Fire-n-Forget

Contents

1. __Header Data__: identification of the service being requested along with parameters for the request.

### Request Stream

Contents

1. __Initial Request N__: initial Request N value. 64-bit integer.
1. __Header Data__: identification of the service being requested along with parameters for the request.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +---------------+-+---------------------------------------------+
    |                         Initial Request N                     |
    |                                                               |
    +---------------------------------------------------------------+
                                Header Data
```

### Request Subscription

Contents

1. __Initial Request N__: initial Request N value. 64-bit integer.
1. __Header Data__: identification of the service being requested along with parameters for the request.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +---------------+-+---------------------------------------------+
    |                         Initial Request N                     |
    |                                                               |
    +---------------------------------------------------------------+
                               Header Data
```

### Request N

Contents

1. __N__: 64-bit integer value of items to request.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +---------------+-+---------------------------------------------+
    |                       Request N                               |
    |                                                               |
    +---------------------------------------------------------------+
```

### Cancel

Contents (NONE)

### Next

Contents

1. 1 Byte Fragment Information:
    1. __Begin Bit__: bit to indicate beginning of a fragmented element.
    1. __End Bit__: bit to indicate end of a fragmented element.
1. __Header Data__: payload for onNext.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     Type      |I|                Header Length                |
    +-+-+-----------+-+---------------------------------------------+
    |B|E|  Reserved |          Header Data (Depends on Type)       ...
    +-+-+-----------+
```

### Error

Contents

1. __Header Data__: error information.

### Complete

Contents (NONE)

### Extension Header

The general format for a header is given below.

```
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |     0xFF      |1|             Extension Type                  |
    +---------------+-+---------------------------------------------+
    |                         Header Length                         |
    +---------------------------------------------------------------+
                          Depends on Extension Type...
```

* __Type__: (8) 0xFF for Extension Header.
* __Flags__:
    * (__I__)gnore: Can be ignored.
* __Header Length__: (24) Length of current header in bytes (32 = max 4,294,967,296 bytes). Includes
the Type, Extension Type, and Header Length fields.

## Connection Establishment

Immediately upon successful connection, the client should send a frame containing a single Setup header with
Stream ID of 0. The client may send requests immediately if it so desires.

If the server accepts the contents of the Setup header, it does nothing special.

If the server does NOT accept the contents of the Setup header, the server MUST send back an ERROR on Stream ID 0
and then close the connection.

__NOTE__: The semantics are similar to [TLS False Start](https://tools.ietf.org/html/draft-bmoeller-tls-falsestart-00).

## Fragmentation And Reassembly

NEXT headers may respresent a large object and MAY need to be fragmented to fit within the Header Data size. When this
occurs, the NEXT headers Begin and End bits must be used to indicate a begin fragment and an end fragment. Or, when
both bits set, the contents represent a complete NEXT header.

## Stream Sequences and Lifetimes

In the section below, "RQ -> RS" refers to Requester sending a frame to a Responder. And "RS -> RQ" refers to Responder sending
a frame to a Requester.

In the section below, "*" refers to 0 or more and "+" refers to 1 or more.

### Request Response

1. RQ -> RS: REQUEST_RESPONSE
1. RS -> RQ: NEXT and COMPLETE

or

1. RQ -> RS: REQUEST_RESPONSE
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_RESPONSE
1. RQ -> RS: CANCEL

Upon sending a response, the stream is terminated on the Responder.

Upon receiving a CANCEL, the stream is terminated on the Responder and the response should not be sent.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

### Request Fire-n-Forget

1. RQ -> RS: REQUEST_FNF

Upon reception, the stream is terminated by the Responder.

Upon being sent, the stream is terminated by the Requester.

### Request Stream

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: NEXT*
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: NEXT+
1. RS -> RQ: COMPLETE

or 

1. RQ -> RS: REQUEST_STREAM
1. RS -> RQ: NEXT*
1. RQ -> RS: CANCEL

At any time, a client may send REQUEST_N frames.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a COMPLETE or ERROR, the stream is terminated on the Requester.

Upon sending a COMPLETE or ERROR, the stream is terminated on the Responder.

### Request Subscription

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: NEXT*

or

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: NEXT*
1. RS -> RQ: ERROR

or

1. RQ -> RS: REQUEST_SUBSCRIPTION
1. RS -> RQ: NEXT*
1. RQ -> RS: CANCEL

At any time, a client may send REQUEST_N frames.

Upon receiving a CANCEL, the stream is terminated on the Responder.

Upon sending a CANCEL, the stream is terminated on the Requester.

Upon receiving a ERROR, the stream is terminated on the Requester.

Upon sending a ERROR, the stream is terminated on the Responder.

### TODO
